<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Silent</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,0.06);
      --accent:#ff758f;
      --muted:rgba(255,255,255,0.75);
      --bubble-me:#ff758f;
      --bubble-them:#2b2f45
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{background:radial-gradient(ellipse at 10% 10%, rgba(255,117,143,0.08), transparent 10%), radial-gradient(ellipse at 90% 90%, rgba(86,163,255,0.05), transparent 20%), var(--bg);color:var(--muted);overflow:hidden}

    /* ---------- RICH & LIVELY BACKGROUND ANIMATIONS ---------- */
    .float-wrap { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
    .float { position:absolute; border-radius:50%; opacity:0.22; filter: blur(30px); mix-blend-mode:screen; transform-origin:center; will-change:transform, opacity; animation: float-drift 20s linear infinite; }
    .float.h1 { width:520px; height:520px; left:-12%; top:8%; background: linear-gradient(135deg,#ff9fb3 0%, #ff758f 60%); }
    .float.h2 { width:380px; height:380px; right:-10%; bottom:4%; background: linear-gradient(135deg,#6fb8ff 0%, #86d0ff 60%); animation-duration:28s; opacity:0.18; }
    .float.s1 { width:160px; height:160px; left:18%; top:62%; background: linear-gradient(135deg,#ffd27a 0%, #ff9f5a 60%); opacity:0.12; animation-duration:16s; }
    .float.s2 { width:110px; height:110px; right:20%; top:14%; background: linear-gradient(135deg,#9bffdd 0%, #5ad8c9 60%); opacity:0.12; animation-duration:14s; }

    @keyframes float-drift {
      0%   { transform: translate3d(0,0,0) rotate(0deg) scale(1); }
      25%  { transform: translate3d(6vw,-12vh,0) rotate(30deg) scale(1.04); }
      50%  { transform: translate3d(0,-28vh,0) rotate(120deg) scale(1.06); }
      75%  { transform: translate3d(-6vw,-12vh,0) rotate(220deg) scale(1.02); }
      100% { transform: translate3d(0,0,0) rotate(360deg) scale(1); }
    }

    .hearts { position:fixed; inset:0; pointer-events:none; z-index:1; }
    .heart, .spark, .num { position:absolute; font-size:20px; opacity:0; transform: translateY(30vh) scale(.8); will-change: transform, opacity; animation: float-rise 6.8s linear infinite; text-shadow: 0 4px 16px rgba(0,0,0,0.45); }
    @keyframes float-rise {
      0%   { opacity:0; transform: translate3d(0,40vh,0) scale(.8) rotate(0); filter: blur(0); }
      10%  { opacity:0.95; transform: translate3d(var(--sx,0),20vh,0) scale(1) rotate(var(--rot,0)); }
      55%  { opacity:0.9; transform: translate3d(calc(var(--sx,0) * -1), -10vh,0) scale(1.02) rotate(calc(var(--rot,0) + 40deg)); }
      100% { opacity:0; transform: translate3d(0,-40vh,0) scale(1.08) rotate(calc(var(--rot,0) + 80deg)); filter: blur(2px); }
    }
    .heart{ font-size:22px; }
    .spark{ font-size:16px; opacity:0.85; filter:drop-shadow(0 4px 8px rgba(255,255,255,0.08)); }
    .num{ font-weight:900; font-size:36px; opacity:0.95; letter-spacing:1px; }

    .heart.h1 { left:8%;  bottom:8%; animation-delay:0.2s; --sx:-6vw; --rot:6deg; }
    .heart.h2 { left:22%; bottom:6%; animation-delay:1.4s; --sx:4vw; --rot:-8deg; animation-duration:7.2s; }
    .heart.h3 { left:40%; bottom:10%; animation-delay:0.8s; --sx:-3vw; --rot:2deg; animation-duration:6.4s; }
    .heart.h4 { left:62%; bottom:6%; animation-delay:1.9s; --sx:5vw; --rot:-12deg; animation-duration:7.6s; }
    .heart.h5 { left:82%; bottom:12%; animation-delay:0.5s; --sx:-2vw; --rot:8deg; animation-duration:6.8s; }

    .spark.s1 { left:14%; top:20%; animation-delay:0.6s; --sx:3vw; --rot:14deg; animation-duration:9s; }
    .spark.s2 { left:76%; top:18%; animation-delay:0.3s; --sx:-3vw; --rot:-18deg; animation-duration:8.2s; }

    .num.n1 { left:18%; bottom:4%; animation-delay:0.4s; animation-duration:7s; --sx:-3vw; --rot:6deg; }
    .num.n2 { left:48%; bottom:6%; animation-delay:1.0s; animation-duration:7.6s; --sx:2vw; --rot:-10deg; }
    .num.n3 { left:78%; bottom:5%; animation-delay:1.6s; animation-duration:6.6s; --sx:-2vw; --rot:4deg; }

    .pop { animation: popPulse 700ms ease-out forwards; }
    @keyframes popPulse {
      0% { transform: scale(1); opacity:1; filter:drop-shadow(0 12px 30px rgba(255,117,143,0.12)); }
      50% { transform: scale(1.25); filter:drop-shadow(0 20px 46px rgba(255,117,143,0.18)); }
      100% { transform: scale(1); filter:drop-shadow(0 6px 20px rgba(255,117,143,0.08)); }
    }

    /* ---------- CHAT UI ---------- */
    .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1.5rem;box-sizing:border-box;z-index:5}
    .card{width:min(980px,96%);height:min(780px,94%);background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));backdrop-filter: blur(8px);border-radius:18px;padding:0;display:flex;flex-direction:column;box-shadow:0 12px 40px rgba(2,6,23,0.6);overflow:hidden;position:relative}
    .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .title{font-weight:700;color:white;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    .chat{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .messages{display:flex;flex-direction:column;gap:8px}
    .msg-row{max-width:78%;display:flex;flex-direction:column}
    .me{align-self:flex-end}
    .them{align-self:flex-start}
    .bubble{padding:10px 14px;border-radius:14px;color:white;font-weight:600;line-height:1.15;box-shadow:0 6px 18px rgba(2,6,23,0.45);word-break:break-word}
    .bubble.me{background:linear-gradient(90deg,var(--bubble-me),#ff9f77);border-bottom-right-radius:4px}
    .bubble.them{background:rgba(255,255,255,0.03);color:var(--muted);border-bottom-left-radius:4px}
    .meta{font-size:11px;opacity:0.85;margin-top:6px;color:rgba(255,255,255,0.8)}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);align-items:end;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02))}
    .composer textarea{flex:1;min-height:56px;max-height:140px;background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:var(--muted);resize:none}
    .btn{background:linear-gradient(90deg,var(--accent),#ff9f77);border:none;padding:10px 14px;border-radius:10px;color:#0b1020;font-weight:700;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .small{font-size:12px;opacity:0.8}
    #pp-status{position:fixed;left:14px;bottom:14px;padding:8px 10px;border-radius:8px;background:rgba(0,0,0,0.45);color:#fff;font-size:12px;z-index:50}
    .overlay{position:fixed;inset:0;background:linear-gradient(rgba(3,6,15,0.55),rgba(3,6,15,0.7));display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{width:min(520px,94%);background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.65);text-align:center;color:var(--muted)}
    @media (max-width:720px){ .card{height:95vh;width:98vw;border-radius:12px} .header{padding:10px} .chat{padding:12px} .composer{padding:10px} }
  </style>
</head>
<body>
  <!-- Animated background (rich & lively) -->
  <div class="float-wrap" aria-hidden="true">
    <div class="float h1"></div>
    <div class="float h2"></div>
    <div class="float s1"></div>
    <div class="float s2"></div>
  </div>

  <div class="hearts" aria-hidden="true">
    <div class="heart h1">‚ù§Ô∏è</div>
    <div class="heart h2">üíï</div>
    <div class="heart h3">üí´</div>
    <div class="heart h4">üíñ</div>
    <div class="heart h5">‚ú®</div>

    <div class="spark s1">‚ú¶</div>
    <div class="spark s2">‚ú∂</div>

    <div class="num n1">110</div>
    <div class="num n2">110</div>
    <div class="num n3">110</div>
  </div>

  <div class="stage">
    <div class="card" role="main" aria-live="polite">
      <div class="header">
        <div class="title">Silent</div>
        <div class="controls">
          <button id="forgetBtn" title="Forget pairing / re-pair" class="ghost">Settings</button>
          <button id="clearBtnTop" class="ghost">Clear Chat</button>
          <button id="fullscreenBtn" class="btn">Full Screen</button>
        </div>
      </div>

      <div class="chat" id="chat">
        <div class="messages" id="messages" aria-live="polite"></div>
      </div>

      <div class="composer">
        <textarea id="text" placeholder="Type a message ‚Äî Ctrl/Cmd+Enter to send"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- pairing modal -->
  <div id="pairModal" class="overlay" style="display:none" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Welcome ‚Äî create or join a pairing code</h2>
      <p class="small">Create a unique code (example: <em>ourcode123</em>) and share it with the other person. All messages saved under that code.</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
        <button id="createPair" class="btn">Create</button>
        <button id="joinPair" class="ghost">Join</button>
      </div>

      <div id="createBox" style="display:none;margin-top:14px">
        <div class="small">Enter a code (2‚Äì20 chars):</div>
        <input id="createInput" placeholder="e.g. ourcode123" style="margin-top:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);width:100%" />
        <div style="margin-top:12px"><button id="doCreate" class="btn">Create & Use</button></div>
      </div>

      <div id="joinBox" style="display:none;margin-top:12px">
        <div class="small">Enter the pairing code you were given:</div>
        <input id="joinInput" placeholder="Enter code" style="margin-top:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);width:100%" />
        <div style="margin-top:12px"><button id="doJoin" class="btn">Join</button></div>
      </div>
    </div>
  </div>

  <div id="pp-status">Status: initializing‚Ä¶</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getDatabase, ref, push, set, get, onChildAdded, remove, off } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ---------- Firebase config (update databaseURL if yours differs) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAbJ1VjQVqMG-AHtdV4lrWW_0uZJ-UGNUs",
      authDomain: "silent-e1320.firebaseapp.com",
      databaseURL: "https://silent-e1320-default-rtdb.firebaseio.com",
      projectId: "silent-e1320",
      storageBucket: "silent-e1320.firebasestorage.app",
      messagingSenderId: "643377091397",
      appId: "1:643377091397:web:198116cc05160954db242c",
      measurementId: "G-RM0MG0SE6T"
    };
    // -------------------------------------------------------------------------------------

    // init firebase
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* ignore analytics issues */ }
    const db = getDatabase(app);

    // DOM
    const messagesEl = document.getElementById('messages');
    const chatEl = document.getElementById('chat');
    const textEl = document.getElementById('text');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtnTop = document.getElementById('clearBtnTop');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const pairModal = document.getElementById('pairModal');
    const createPairBtn = document.getElementById('createPair');
    const joinPairBtn = document.getElementById('joinPair');
    const createBox = document.getElementById('createBox');
    const joinBox = document.getElementById('joinBox');
    const createInput = document.getElementById('createInput');
    const joinInput = document.getElementById('joinInput');
    const doCreate = document.getElementById('doCreate');
    const doJoin = document.getElementById('doJoin');
    const ppStatus = document.getElementById('pp-status');
    const forgetBtn = document.getElementById('forgetBtn');

    const LOCAL_PAIR_KEY = 'peacepage_pair_code_chat_v1';
    const CLIENT_ID_KEY = 'peacepage_client_id_v1';
    let pairCode = null;
    let messagesPath = null;
    let attached = false;

    function setStatus(s){
      if (ppStatus) ppStatus.textContent = 'Status: ' + s;
      console.log('[pp]', s);
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function clientId(){
      let id = localStorage.getItem(CLIENT_ID_KEY);
      if (!id){ id = 'c_' + Math.random().toString(36).slice(2,9); localStorage.setItem(CLIENT_ID_KEY, id); }
      return id;
    }

    function flash110(){
      const el1 = document.querySelector('.num.n1');
      const el2 = document.querySelector('.num.n2');
      const el3 = document.querySelector('.num.n3');
      [el1,el2,el3].forEach(el=>{
        if(!el) return;
        el.classList.add('pop');
        setTimeout(()=>el.classList.remove('pop'), 700);
      });
    }

    function appendMessage(data){
      const isMine = data.sender === clientId();
      const row = document.createElement('div');
      row.className = 'msg-row ' + (isMine ? 'me' : 'them');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (isMine ? 'me' : 'them');
      const textNode = document.createElement('div');
      textNode.innerHTML = escapeHtml(data.text || '');
      bubble.appendChild(textNode);
      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = data.t ? new Date(data.t).toLocaleString() : '';
      meta.textContent = (isMine ? 'You' : 'Them') + ' ¬∑ ' + time;
      bubble.appendChild(meta);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      // keep DOM bounded
      while (messagesEl.children.length > 1000) messagesEl.removeChild(messagesEl.firstChild);
      // scroll to bottom
      chatEl.scrollTop = chatEl.scrollHeight + 200;
      // pulse background numbers
      flash110();
    }

    // attach listener for current pair
    function attachListeners(){
      if (!pairCode || attached) return;
      attached = true;
      messagesPath = `peacepage/messages/${pairCode}`;
      const nodeRef = ref(db, messagesPath);
      // clear DOM to avoid duplicates
      messagesEl.innerHTML = '';
      setStatus('listening for messages');
      onChildAdded(nodeRef, snap => {
        const d = snap.val();
        if (d) appendMessage(d);
        setStatus('listening');
      }, err => {
        console.error('onChildAdded error', err);
        setStatus('realtime error');
      });
    }

    // detach listeners when forgetting or repairing
    function detachListeners(){
      if (!pairCode) return;
      try{
        const nodeRef = ref(db, `peacepage/messages/${pairCode}`);
        off(nodeRef); // remove all listeners for that ref
      }catch(e){ /* ignore */ }
      attached = false;
    }

    // helpers to read/write pairing node
    async function readRemotePair(){
      try{
        const snap = await get(ref(db, 'peacepage/pairing'));
        if (!snap.exists()) return null;
        return snap.val().code ?? null;
      }catch(e){ console.warn('readRemotePair', e); return null; }
    }
    async function writeRemotePair(code){
      try{
        await set(ref(db, 'peacepage/pairing'), { code, updatedAt: Date.now() });
        return true;
      }catch(e){ console.error('writeRemotePair', e); return false; }
    }

    // send message
    async function sendMessage(text){
      if (!pairCode){ pairModal.style.display = 'flex'; setStatus('no pairing'); return; }
      setStatus('validating pairing...');
      const remote = await readRemotePair();
      if (!remote){ alert('No pairing created in cloud. Create first.'); setStatus('no remote'); return; }
      if (remote !== pairCode){ alert('Local pairing mismatch. Re-pair.'); setStatus('pair mismatch'); pairModal.style.display = 'flex'; return; }
      const nodeRef = ref(db, `peacepage/messages/${pairCode}`);
      try{
        setStatus('sending...');
        await push(nodeRef, { text, t: Date.now(), sender: clientId() });
        setStatus('sent');
      }catch(e){
        console.error('send error', e);
        setStatus('send failed');
        alert('Failed to send.');
      }
    }

    // clear chat
    async function clearChat(){
      if (!pairCode) return alert('No pairing set.');
      if (!confirm('Clear chat history for this pairing?')) return;
      try{
        await remove(ref(db, `peacepage/messages/${pairCode}`));
        messagesEl.innerHTML = '';
        setStatus('cleared');
      }catch(e){ console.error('clear error', e); alert('Failed to clear.'); }
    }

    // forget local pairing
    function forgetLocal(){
      if (!confirm('Forget pairing on this device?')) return;
      detachListeners();
      localStorage.removeItem(LOCAL_PAIR_KEY);
      pairCode = null;
      messagesEl.innerHTML = '';
      attached = false;
      pairModal.style.display = 'flex';
      setStatus('forgot pairing');
    }

    // UI events
    sendBtn.addEventListener('click', ()=>{ const t = (textEl.value || '').trim(); if (!t) return; sendMessage(t); textEl.value=''; });
    textEl.addEventListener('keydown', e=>{ if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) sendBtn.click(); });
    clearBtnTop.addEventListener('click', clearChat);
    forgetBtn.addEventListener('click', forgetLocal);
    fullscreenBtn.addEventListener('click', ()=>{ const el=document.documentElement; if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });

    createPairBtn.addEventListener('click', ()=>{ createBox.style.display='block'; joinBox.style.display='none'; createInput.focus(); });
    joinPairBtn.addEventListener('click', ()=>{ joinBox.style.display='block'; createBox.style.display='none'; joinInput.focus(); });

    doCreate.addEventListener('click', async ()=>{
      const code = (createInput.value || '').trim();
      if (!code || code.length < 2) return alert('Enter a code (2‚Äì20 chars).');
      setStatus('creating pairing...');
      const ok = await writeRemotePair(code);
      if (!ok){ alert('Create failed'); setStatus('create failed'); return; }
      localStorage.setItem(LOCAL_PAIR_KEY, code);
      pairCode = code;
      pairModal.style.display = 'none';
      setStatus('paired (creator)');
      attachListeners();
    });

    doJoin.addEventListener('click', async ()=>{
      const code = (joinInput.value || '').trim();
      if (!code) return alert('Enter code to join.');
      setStatus('checking pairing...');
      const remote = await readRemotePair();
      if (!remote){ alert('No pairing created. Ask other to create.'); setStatus('no remote'); return; }
      if (code !== remote){ alert('Pairing code incorrect.'); setStatus('join failed'); return; }
      localStorage.setItem(LOCAL_PAIR_KEY, code);
      pairCode = code;
      pairModal.style.display = 'none';
      setStatus('paired (joined)');
      attachListeners();
    });

    // init
    (async function init(){
      try{
        setStatus('initializing...');
        const local = localStorage.getItem(LOCAL_PAIR_KEY);
        const remote = await readRemotePair();
        if (!local){
          pairModal.style.display = 'flex';
          setStatus('waiting for pairing');
        } else {
          if (remote && remote === local){
            pairCode = local;
            pairModal.style.display = 'none';
            setStatus('paired (restored)');
            attachListeners();
          } else if (!remote){
            pairModal.style.display = 'flex';
            setStatus('no remote pairing');
          } else {
            pairModal.style.display = 'flex';
            setStatus('pair mismatch');
          }
        }
      }catch(e){
        console.error('init error', e);
        setStatus('init error');
        pairModal.style.display = 'flex';
      }
    })();
  </script>
</body>
</html>
